<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendario Académico</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #4361ee;
      --primary-dark: #3a56d4;
      --primary-light: #e6eeff;
      --secondary-color: #7209b7;
      --accent-color: #f72585;
      --success-color: #4cc9f0;
      --warning-color: #f9c74f;
      --error-color: #f94144;
      --text-color: #2b2d42;
      --text-light: #6c757d;
      --bg-light: #f8f9fa;
      --bg-white: #ffffff;
      --border-radius: 12px;
      --border-radius-sm: 8px;
      --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      --box-shadow-hover: 0 15px 35px rgba(0, 0, 0, 0.12);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
    }

    .app-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header Styles */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-white);
      padding: 20px 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 30px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo i {
      font-size: 28px;
      color: var(--primary-color);
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary-color);
      margin: 0;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(67, 97, 238, 0.2);
    }

    /* Calendar Table */
    .calendar-wrapper {
      background: var(--bg-white);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
      margin-bottom: 30px;
      position: relative;
    }

    .calendar-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .calendar-table th {
      background: var(--primary-light);
      color: var(--primary-color);
      font-weight: 600;
      padding: 15px 10px;
      text-align: center;
      position: relative;
    }

    .calendar-table th:first-child {
      width: 80px;
    }

    .calendar-table td {
      border: 1px solid #e9ecef;
      padding: 0;
      height: 60px;
      vertical-align: top;
      position: relative;
    }

    .time-cell {
      background: var(--bg-light);
      font-size: 0.85rem;
      color: var(--text-light);
      text-align: center;
      padding: 5px;
      font-weight: 500;
    }

    .materia-block {
      position: absolute;
      left: 1px;
      right: 1px;
      padding: 8px;
      color: white;
      font-size: 0.75rem;
      border-radius: var(--border-radius-sm);
      overflow: hidden;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 1;
    }

    .materia-block:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 2;
    }

    .materia-name {
      font-weight: 600;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .materia-time {
      font-size: 0.7rem;
      opacity: 0.9;
    }

    .choque {
      background: var(--error-color) !important;
      animation: pulse 2s infinite;
      z-index: 3;
    }

    @keyframes pulse {
      0% { opacity: 0.9; }
      50% { opacity: 0.7; }
      100% { opacity: 0.9; }
    }

    /* Legend */
    .legend {
      background: var(--bg-white);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }

    .legend-title {
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-items {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }

    .legend-text {
      font-size: 0.9rem;
    }

    /* Conflict Panel */
    .conflict-panel {
      background: #fff8f8;
      border: 1px solid #ffcccc;
      border-radius: var(--border-radius);
      padding: 15px 20px;
      margin-bottom: 20px;
    }

    .conflict-header {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--error-color);
      margin-bottom: 10px;
    }

    .conflict-list {
      list-style: none;
    }

    .conflict-item {
      padding: 8px 0;
      border-bottom: 1px solid #ffdddd;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .conflict-item:last-child {
      border-bottom: none;
    }

    /* Responsive Design */
    @media (max-width: 992px) {
      .calendar-table th:first-child {
        width: 60px;
      }
      
      .materia-block {
        padding: 4px;
        font-size: 0.7rem;
      }
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
        padding: 20px;
      }
      
      .calendar-table {
        font-size: 0.8rem;
      }
      
      .time-cell {
        font-size: 0.75rem;
      }
      
      .materia-block {
        font-size: 0.65rem;
        padding: 2px;
      }
      
      .legend-items {
        flex-direction: column;
        gap: 10px;
      }
    }

    /* Loading State */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 60px 20px;
      flex-direction: column;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--primary-light);
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 30px;
      right: 30px;
      padding: 15px 25px;
      border-radius: var(--border-radius-sm);
      color: white;
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      transform: translateX(100px);
      transition: opacity 0.3s, transform 0.3s;
      box-shadow: var(--box-shadow);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .notification.success {
      background: var(--success-color);
      opacity: 1;
      transform: translateX(0);
    }

    .notification.error {
      background: var(--error-color);
      opacity: 1;
      transform: translateX(0);
    }

    /* Tooltip */
    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.8rem;
      z-index: 100;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      max-width: 250px;
    }
  </style>
</head>

<body>
  <div class="app-container">
    <div class="header">
      <div class="logo">
        <i class="fas fa-calendar-alt"></i>
        <h1>Calendario Académico</h1>
      </div>
      <button class="btn btn-primary" id="volverInicio">
        <i class="fas fa-arrow-left"></i> Volver al Inicio
      </button>
    </div>

    <div id="conflictContainer"></div>

    <div class="calendar-wrapper">
      <table class="calendar-table">
        <thead>
          <tr>
            <th>Hora</th>
            <th>Lunes</th>
            <th>Martes</th>
            <th>Miércoles</th>
            <th>Jueves</th>
            <th>Viernes</th>
          </tr>
        </thead>
        <tbody id="calendarBody">
          <!-- Las filas se generarán con JavaScript -->
        </tbody>
      </table>
    </div>

    <div class="legend">
      <div class="legend-title">
        <i class="fas fa-info-circle"></i>
        Leyenda
      </div>
      <div class="legend-items" id="legendItems">
        <!-- La leyenda se generará con JavaScript -->
      </div>
    </div>
  </div>

  <div id="notification" class="notification"></div>
  <div id="tooltip" class="tooltip"></div>

  <script>
    document.getElementById("volverInicio").addEventListener("click", () => {
      window.location.href = "/inicio";
    });

    const dias = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"];
    const tbody = document.querySelector("#calendarBody");
    const conflictContainer = document.getElementById("conflictContainer");
    const tooltip = document.getElementById("tooltip");

    // Generar las filas de horas
    function generateTimeRows(materias) {
      tbody.innerHTML = '';

      // Determinar la hora mínima y máxima de todas las materias
      let minHora = 24;
      let maxHora = 0;

      materias.forEach(materia => {
        materia.horarios.forEach(horario => {
          const [hi] = horario.horaInicio.split(":").map(Number);
          const [hf] = horario.horaFin.split(":").map(Number);
          if (hi < minHora) minHora = hi;
          if (hf > maxHora) maxHora = hf;
        });
      });

      // Si no hay materias, establecer rango por defecto
      if (minHora === 24) minHora = 7;
      if (maxHora === 0) maxHora = 21;

      // Crear filas de minHora a maxHora
      for (let h = minHora; h < maxHora; h++) {
        const tr = document.createElement("tr");
        const horaStr = h.toString().padStart(2, "0") + ":00";
        const tdHora = document.createElement("td");
        tdHora.className = "time-cell";
        tdHora.textContent = horaStr;
        tr.appendChild(tdHora);

        dias.forEach(dia => {
          const td = document.createElement("td");
          td.dataset.dia = dia;
          td.dataset.hora = horaStr;
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      }
    }

    // Mostrar notificación
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;
      
      setTimeout(() => {
        notification.className = 'notification';
      }, 3000);
    }

    // Mostrar tooltip
    function showTooltip(content, x, y) {
      tooltip.innerHTML = content;
      tooltip.style.left = `${x + 10}px`;
      tooltip.style.top = `${y + 10}px`;
      tooltip.style.opacity = '1';
    }

    function hideTooltip() {
      tooltip.style.opacity = '0';
    }

    // Detectar y mostrar conflictos de horario
    function detectAndDisplayConflicts(conflicts) {
      conflictContainer.innerHTML = '';
      
      if (conflicts.length === 0) return;
      
      const conflictPanel = document.createElement('div');
      conflictPanel.className = 'conflict-panel';
      conflictPanel.innerHTML = `
        <div class="conflict-header">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>Conflictos de Horario Detectados</h3>
        </div>
        <ul class="conflict-list">
          ${conflicts.map(conflict => `
            <li class="conflict-item">
              <i class="fas fa-clock"></i>
              ${conflict.dia} a las ${conflict.hora}: ${conflict.materias.join(' vs ')}
            </li>
          `).join('')}
        </ul>
      `;
      
      conflictContainer.appendChild(conflictPanel);
    }

    // Función para calcular solapamientos y organizar visualmente
    function organizeTimeBlocks(blocks) {
      if (blocks.length === 0) return [];
      
      // Ordenar bloques por hora de inicio
      blocks.sort((a, b) => {
        const [ha, ma] = a.horaInicio.split(':').map(Number);
        const [hb, mb] = b.horaInicio.split(':').map(Number);
        return (ha * 60 + ma) - (hb * 60 + mb);
      });
      
      const groups = [];
      let currentGroup = [];
      
      for (const block of blocks) {
        if (currentGroup.length === 0) {
          currentGroup.push(block);
        } else {
          const lastBlock = currentGroup[currentGroup.length - 1];
          const [hLast, mLast] = lastBlock.horaFin.split(':').map(Number);
          const [hCurrent, mCurrent] = block.horaInicio.split(':').map(Number);
          
          // Si el bloque actual comienza antes de que termine el último, hay solapamiento
          if (hCurrent * 60 + mCurrent < hLast * 60 + mLast) {
            currentGroup.push(block);
          } else {
            groups.push(currentGroup);
            currentGroup = [block];
          }
        }
      }
      
      if (currentGroup.length > 0) {
        groups.push(currentGroup);
      }
      
      return groups;
    }

    // Función para cargar materias desde el backend
    async function cargarMaterias() {
      try {
        // Mostrar estado de carga
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="loading">
              <div class="spinner"></div>
              <p>Cargando calendario...</p>
            </td>
          </tr>
        `;

        const token = localStorage.getItem("token");
        if (!token) throw new Error("No se encontró token de autenticación");

        const res = await fetch("/estudiantes/calendario", {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) throw new Error(`Error ${res.status}: ${res.statusText}`);

        const materiasUsuario = await res.json();

        if (!Array.isArray(materiasUsuario)) {
          console.error("La respuesta del backend no es un array:", materiasUsuario);
          showNotification("Error al cargar el calendario", "error");
          return;
        }

        // Regenerar las filas
        generateTimeRows(materiasUsuario);
        
        // Limpiar leyenda
        document.getElementById("legendItems").innerHTML = '';
        
        // Mapa de colores para materias
        const colorMap = new Map();
        
        // Paleta de colores atractivos
        const colorPalette = [
          '#4361ee', '#7209b7', '#f72585', '#4cc9f0', '#560bad',
          '#b5179e', '#4895ef', '#3a0ca3', '#f07167', '#f9c74f'
        ];

        // Asignar colores a las materias
        materiasUsuario.forEach((materia, index) => {
          const colorIndex = index % colorPalette.length;
          const color = colorPalette[colorIndex];
          colorMap.set(materia._id, color);
          
          // Añadir a la leyenda
          const legendItem = document.createElement('div');
          legendItem.className = 'legend-item';
          legendItem.innerHTML = `
            <div class="legend-color" style="background: ${color}"></div>
            <div class="legend-text">${materia.nombre}</div>
          `;
          document.getElementById('legendItems').appendChild(legendItem);
        });

        // Almacenar conflictos para mostrarlos después
        const allConflicts = [];
        
        // Procesar cada día
        dias.forEach(dia => {
          // Recolectar todos los bloques para este día
          const dayBlocks = [];
          
          materiasUsuario.forEach(materia => {
            materia.horarios.forEach(horario => {
              if (horario.dia === dia) {
                dayBlocks.push({
                  materiaId: materia._id,
                  materiaNombre: materia.nombre,
                  horaInicio: horario.horaInicio,
                  horaFin: horario.horaFin,
                  color: colorMap.get(materia._id)
                });
              }
            });
          });
          
          // Organizar bloques por solapamiento
          const blockGroups = organizeTimeBlocks(dayBlocks);
          
          // Procesar cada grupo de bloques
          blockGroups.forEach((group, groupIndex) => {
            if (group.length > 1) {
              // Hay solapamiento en este grupo
              const conflict = {
                dia: dia,
                hora: group[0].horaInicio,
                materias: group.map(b => b.materiaNombre)
              };
              allConflicts.push(conflict);
            }
            
            // Calcular el ancho y posición de cada bloque en el grupo
            const groupWidth = 100 / group.length;
            
            group.forEach((block, blockIndex) => {
              const [hi, mi] = block.horaInicio.split(":").map(Number);
              const [hf, mf] = block.horaFin.split(":").map(Number);
              
              // Calcular posición vertical
              const startMinute = hi * 60 + mi;
              const endMinute = hf * 60 + mf;
              const duration = endMinute - startMinute;
              
              // Encontrar la fila correspondiente
              for (let h = hi; h < hf; h++) {
                const horaStr = h.toString().padStart(2, "0") + ":00";
                const td = document.querySelector(`td[data-dia="${dia}"][data-hora="${horaStr}"]`);
                
                if (td) {
                  const bloque = document.createElement("div");
                  bloque.classList.add("materia-block");
                  if (group.length > 1) {
                    bloque.classList.add("choque");
                  }
                  
                  bloque.style.background = block.color;
                  bloque.dataset.materiaId = block.materiaId;
                  bloque.dataset.materiaNombre = block.materiaNombre;
                  
                  bloque.innerHTML = `
                    <div class="materia-name">${block.materiaNombre}</div>
                    <div class="materia-time">${block.horaInicio} - ${block.horaFin}</div>
                  `;
                  
                  // Posicionamiento para bloques solapados
                  if (group.length > 1) {
                    bloque.style.width = `${groupWidth}%`;
                    bloque.style.left = `${blockIndex * groupWidth}%`;
                  }
                  
                  // Posicionamiento vertical
                  const cellStartMinute = h * 60;
                  const top = Math.max(0, (startMinute - cellStartMinute) / 60 * 100);
                  const bottom = Math.min(100, (endMinute - cellStartMinute) / 60 * 100);
                  const height = bottom - top;
                  
                  bloque.style.top = `${top}%`;
                  bloque.style.height = `${height}%`;
                  
                  // Eventos para tooltip
                  bloque.addEventListener('mouseover', (e) => {
                    const content = `
                      <strong>${block.materiaNombre}</strong><br>
                      ${dia} ${block.horaInicio} - ${block.horaFin}
                      ${group.length > 1 ? '<br><span style="color:#ff9999">Conflicto de horario</span>' : ''}
                    `;
                    showTooltip(content, e.clientX, e.clientY);
                  });
                  
                  bloque.addEventListener('mouseout', hideTooltip);
                  
                  td.appendChild(bloque);
                }
              }
            });
          });
        });
        
        // Mostrar panel de conflictos si los hay
        detectAndDisplayConflicts(allConflicts);
        
        if (allConflicts.length > 0) {
          showNotification(`Se detectaron ${allConflicts.length} conflicto(s) de horario`, "error");
        }
        
      } catch (err) {
        console.error("Error cargando materias:", err);
        showNotification("Error al cargar el calendario: " + err.message, "error");
      }
    }

    // Inicializar
    cargarMaterias();
  </script>
</body>
</html>